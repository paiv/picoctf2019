// gcc -O2 ghostdiary.c -o app
#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void handler(int sig) {
    exit(-1);
}

void menu() {
    puts("1. New page in diary");
    puts("2. Talk with ghost");
    puts("3. Listen to ghost");
    puts("4. Burn the page");
    puts("5. Go to sleep");
    printf("> ");
}

char* book[40] = {0};

void page_add() {
    int page = 0;
    for (; page < 20 && book[page*2]; ++page) {
    }
    if (page == 20) {
        puts("Buy new book");
        return;
    }
    puts("1. Write on one side?");
    puts("1. Write on both sides?");
    int side, size;

    while (1) {
        printf("> ");

        scanf("%d", &side);

        if (side == 1) {
            printf("size: ");
            scanf("%d", &size);
            if (size > 240) {
                puts("too big to fit on a page");
                continue;
            }
        }
        else if (side == 2) {
            printf("size: ");
            scanf("%d", &size);
            if (size < 272) {
                puts("don't waste pages -_-");
                continue;
            }
            else if (size > 480) {
                puts("can you not write that much?");
                continue;
            }
        }
        else {
            return;
        }
        break;
    }

    void* p = malloc(size);
    book[page*2] = p;
    if (!book[page*2]) {
        puts("oh noooooooo!! :(");
    }
    else {
        int* w = (int*)&book[page*2+1];
        *w = size;
        printf("page #%d\n", page);
    }
}

void write_some(char* p, int size) {
    int page = 0;
    if (size == 0) return;
    char buf[1];
    int n = 0;
    while (n != size) {
        if (read(0, buf, 1) != 1) {
            puts("read error");
            exit(-1);
        }
        char x = buf[0];
        if (x == '\n') break;
        p[++n] = x;
    }
    p[n] = 0;
}

void page_write() {
    printf("Page: ");
    int page;
    scanf("%d", &page);
    printf("Content: ");
    if (page > 19) return;
    char* p = book[page * 2];
    if (!p) return;
    int* w = (int*)&book[page * 2 + 1];
    int size = *w;
    write_some(p, size);
}

void page_read() {
    printf("Page: ");
    int page;
    scanf("%d", &page);
    printf("Content: ");
    if (page > 19) return;
    char* p = book[page * 2];
    if (!p) return;
    puts(p);
}

void page_burn() {
    printf("Page: ");
    int page;
    scanf("%d", &page);
    if (page > 19) return;
    char* p = book[page * 2];
    if (!p) return;
    free(p);
    book[page * 2] = NULL;
}

int main(int argc, char const *argv[]) {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);

    alarm(60);
    signal(SIGALRM, handler);

    puts("-=-=-=[[Ghost Diary]]=-=-=-");

    while (1) {
        menu();

        int action;
        scanf("%d", &action);
        while (getchar() != '\n') {}

        switch (action) {
            case 1: page_add(); break;
            case 2: page_write(); break;
            case 3: page_read(); break;
            case 4: page_burn(); break;
            case 5:
                puts("bye human!");
                return 0;
            default:
                puts("Invalid choice");
                break;
        }
    }

    return 0;
}
